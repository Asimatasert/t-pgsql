#compdef t-pgsql

_t-pgsql() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    _arguments -C \
        '1:command:->commands' \
        '*:options:->options'

    case $state in
        commands)
            local -a commands
            commands=(
                'dump:Create database backup'
                'restore:Restore backup to database'
                'clone:Dump + Restore (full sync)'
                'fetch:Fetch existing dump from remote'
                'batch:Run multiple jobs'
                'jobs:Manage saved jobs'
                'list:List dump files'
                'meta:Show metadata'
                'clean:Clean old dumps'
                'version:Show version'
                'help:Show help'
            )
            _describe -t commands 'command' commands
            ;;
        options)
            local -a opts
            opts=(
                '--from[Source connection]'
                '--to[Target connection]'
                '--password[Password]'
                '--from-password[Source password]'
                '--to-password[Target password]'
                '--password-file[Password file]:file:_files'
                '--from-password-file[Source password file]:file:_files'
                '--to-password-file[Target password file]:file:_files'
                '--config[Config file]:file:_files'
                '--exclude-table[Exclude tables]'
                '--exclude-schema[Exclude schemas]'
                '--exclude-data[Exclude data only]'
                '--only-table[Only these tables]'
                '--only-schema[Only these schemas]'
                '--compress[Compression type]:type:(gzip zstd xz bzip2 none)'
                '--compress-level[Compression level 1-9]'
                '--pg-compress-level[pg_dump compression 0-9]'
                '--output[Output directory]:dir:_files -/'
                '--dump-name[Custom dump filename]'
                '--keep[Keep N local dumps]'
                '--from-keep[Keep N on source]'
                '--skip-if-recent[Skip if recent dump exists]:time:(today 24h 12h 6h 1d)'
                '--from-file[Fetch existing dump]'
                '--yaml[Custom YAML file]:yaml:_files -g "*.yaml"'
                '--retention[Enable GFS retention]'
                '--retention-daily[Daily backups]'
                '--retention-weekly[Weekly backups]'
                '--retention-monthly[Monthly backups]'
                '--retention-yearly[Yearly backups]'
                '--health-check[Check before]'
                '--health-check-after[Check after]'
                '--no-health-check[Disable checks]'
                '--notify[Notification channel]'
                '--notify-on-error[Only on error]'
                '--mask[Enable masking]'
                '--mask-rules[Masking rules]:file:_files'
                '--mask-tables[Tables to mask]'
                '--stream[Stream mode]'
                '--stream-buffer[Buffer size MB]'
                '--sudo[Use sudo]'
                '--parallel[Parallel jobs]'
                '--continue-on-error[Continue on error]'
                '--save[Save as job]'
                '--batch[Run batch job]'
                '--file[Dump file]:file:_files'
                '--log[Log file]:file:_files'
                '--log-level[Log level]:level:(debug info warn error)'
                {-v,--verbose}'[Verbose output]'
                {-q,--quiet}'[Quiet output]'
                {-y,--yes}'[Skip confirmations]'
                {-f,--force}'[Force overwrite]'
                '--dry-run[Dry run]'
                '--no-meta[No meta files]'
                {-h,--help}'[Show help]'
                '--version[Show version]'
            )
            _describe -t options 'option' opts
            # Also allow _arguments style completion
            _arguments -s $opts
            ;;
    esac
}

_t-pgsql "$@"
